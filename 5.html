const occasionalIncome = {
                credit: parseInt(document.getElementById('occasionalCredit').value) || 0,
                bank: parseInt(document.getElementById('occasionalBank').value) || 0,
                cash: parseInt(document.getElementById('occasionalCash').value) || 0,
                transfers: parseInt(document.getElementById('occasionalTransfers').value) || 0,
                checks: parseInt(document.getElementById('occasionalChecks').value) || 0
            };

            const salaries = {
                abraham: parseInt(document.getElementById('salaryAbraham').value) || 0,
                shlomo: parseInt(document.getElementById('salaryShlomo').value) || 0,
                nachman: parseInt(document.getElementById('salaryNachman').value) || 0
            };

            const office = {
                rent: parseInt(document.getElementById('officeRent').value) || 0,
                utilities: parseInt(document.getElementById('officeUtilities').value) || 0
            };

            const otherExpenses = {
                debtPolak: parseInt(document.getElementById('debtPolak').value) || 0,
                advertising: parseInt(document.getElementById('advertising').value) || 0,
                passoverDebt: parseInt(document.getElementById('passoverDebt').value) || 0,
                software: parseInt(document.getElementById('software').value) || 0,
                commissions: parseInt(document.getElementById('commissions').value) || 0,
                deferredCharges: parseInt(document.getElementById('deferredCharges').value) || 0
            };

            // איסוף הוצאות מותאמות אישית
            const customExpenses = [];
            const customExpenseItems = document.querySelectorAll('.custom-expense-item');
            
            customExpenseItems.forEach(item => {
                const id = item.id.split('-')[2];
                const nameElement = document.getElementById(`customExpenseName-${id}`);
                const amountElement = document.getElementById(`customExpenseAmount-${id}`);
                
                if (nameElement && amountElement && nameElement.value.trim()) {
                    const expense = {
                        name: nameElement.value.trim(),
                        amount: parseInt(amountElement.value) || 0,
                        subExpenses: []
                    };
                    
                    // איסוף תתי הוצאות
                    const subExpenseItems = item.querySelectorAll('.sub-expense-item');
                    subExpenseItems.forEach(subItem => {
                        const subId = subItem.id.split('-')[2] + '-' + subItem.id.split('-')[3];
                        const subNameElement = document.getElementById(`subExpenseName-${subId}`);
                        const subAmountElement = document.getElementById(`subExpenseAmount-${subId}`);
                        
                        if (subNameElement && subAmountElement && subNameElement.value.trim()) {
                            expense.subExpenses.push({
                                name: subNameElement.value.trim(),
                                amount: parseInt(subAmountElement.value) || 0
                            });
                        }
                    });
                    
                    customExpenses.push(expense);
                }
            });

            const banks = {
                pagiKeren: {
                    income: parseInt(document.getElementById('pagiKerenIncome').value) || 0,
                    scholarships: parseInt(document.getElementById('pagiKerenScholarships').value) || 0,
                    salaries: parseInt(document.getElementById('pagiKerenSalaries').value) || 0
                },
                pagiBeit: {
                    income: parseInt(document.getElementById('pagiBeitIncome').value) || 0,
                    expenses: parseInt(document.getElementById('pagiBeitExpenses').value) || 0
                },
                merkantil: {
                    income: parseInt(document.getElementById('merkantilIncome').value) || 0,
                    scholarships: parseInt(document.getElementById('merkantilScholarships').value) || 0,
                    salaries: parseInt(document.getElementById('merkantilSalaries').value) || 0
                }
            };

            // חישובים
            const totalRegularIncome = Object.values(regularIncome).reduce((a, b) => a + b, 0);
            const totalOccasionalIncome = Object.values(occasionalIncome).reduce((a, b) => a + b, 0);
            const totalIncome = totalRegularIncome + totalOccasionalIncome;

            const totalSalaries = Object.values(salaries).reduce((a, b) => a + b, 0);
            const totalOffice = Object.values(office).reduce((a, b) => a + b, 0);
            const totalOther = Object.values(otherExpenses).reduce((a, b) => a + b, 0);
            const totalCustomExpenses = customExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const totalExpenses = totalScholarships + totalSalaries + totalOffice + totalOther + totalCustomExpenses;

            const balance = totalIncome - totalExpenses;

            return {
                month, year, totalDonors, totalRecipients, totalScholarships, previousBalance,
                regularIncome, occasionalIncome, salaries, office, otherExpenses, customExpenses, banks,
                totalIncome, totalExpenses, balance,
                totalRegularIncome, totalOccasionalIncome, totalSalaries, totalOffice, totalOther, totalCustomExpenses
            };
        }

        // יצירת דוחות
        function generateReports() {
            console.log('מתחיל ליצור דוחות...');
            const data = collectFormData();
            
            if (!data.month || !data.year) {
                alert('נא למלא את פרטי החודש והשנה');
                return;
            }

            const fileName1 = `${data.year}${data.month.toString().padStart(2, '0')}-1.html`;
            const fileName2 = `${data.year}${data.month.toString().padStart(2, '0')}-2.html`;
            
            const mainReport = generateMainReport(data);
            const detailedReport = generateDetailedReport(data);

            generatedFilesData = [
                { name: fileName1, content: mainReport, title: 'דוח כללי' },
                { name: fileName2, content: detailedReport, title: 'דוח מפורט לפי בנקים' }
            ];

            displayGeneratedFiles();
        }

        // יצירת דוח ראשי
        function generateMainReport(data) {
            const monthName = monthNames[data.month];
            
            return `<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <title>דוח הכנסות והוצאות - חודש ${data.month}</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { margin: 0; font-size: 2.5em; font-weight: 300; }
        .content { padding: 40px; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-bottom: 40px; }
        .card { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 15px; padding: 30px; text-align: center; position: relative; overflow: hidden; }
        .card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 5px; }
        .card.info::before { background: linear-gradient(90deg, #17a2b8, #20c997); }
        .card.pending::before { background: linear-gradient(90deg, #ffc107, #fd7e14); }
        .card.revenue::before { background: linear-gradient(90deg, #28a745, #20c997); }
        .card.expenses::before { background: linear-gradient(90deg, #dc3545, #fd7e14); }
        .card h3 { margin: 0 0 15px 0; color: #495057; font-size: 1.1em; font-weight: 600; }
        .card .amount { font-size: 2.2em; font-weight: bold; margin: 10px 0; }
        .card.revenue .amount { color: #28a745; }
        .card.expenses .amount { color: #dc3545; }
        .card.info .amount { color: #17a2b8; }
        .card.pending .amount { color: #ffc107; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        th, td { padding: 15px; text-align: right; border-bottom: 1px solid #e9ecef; }
        th { background: linear-gradient(135deg, #495057 0%, #6c757d 100%); color: white; font-weight: 600; }
        .total-row { background: #e9ecef !important; font-weight: bold; border-top: 2px solid #dee2e6; }
        .expandable-row { cursor: pointer; transition: background-color 0.2s ease; }
        .expandable-row:hover { background: #e3f2fd !important; }
        .detail-row { display: none; background: #f0f8ff !important; }
        .detail-row.show { display: table-row; }
        .detail-row td { padding-right: 40px; font-size: 0.9em; color: #666; border-bottom: 1px dashed #ddd; }
        .arrow-col { width: 30px; text-align: center; color: #6c757d; font-weight: normal; font-size: 0.8em; }
        .tables-container { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 40px; }
        .table-section { background: #f8f9fa; border-radius: 15px; padding: 25px; border: 2px solid #e9ecef; }
        .table-section h3 { margin: 0 0 20px 0; color: #495057; font-size: 1.3em; padding-bottom: 10px; border-bottom: 3px solid #dee2e6; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>דוח הכנסות והוצאות</h1>
            <div class="period">חודש ${monthName} ${data.year}</div>
        </div>
        
        <div class="content">
            <div class="summary-cards">
                <div class="card info">
                    <h3>סך תורמים</h3>
                    <div class="amount">${data.totalDonors}</div>
                    <div>תורמים פעילים</div>
                </div>
                <div class="card info">
                    <h3>סך אברכים המקבלים מלגה</h3>
                    <div class="amount">${data.totalRecipients}</div>
                    <div>מקבלי מלגות</div>
                </div>
                <div class="card pending">
                    <h3>חולקו מלגות על סך</h3>
                    <div class="amount">₪${data.totalScholarships.toLocaleString()}</div>
                </div>
                <div class="card pending">
                    <h3>יתרת מלגות קודמות</h3>
                    <div class="amount">₪${data.previousBalance.toLocaleString()}</div>
                    <div>שלא נגבו</div>
                </div>
            </div>
            
            <div class="summary-cards">
                <div class="card revenue">
                    <h3>סך הכנסות</h3>
                    <div class="amount">₪${data.totalIncome.toLocaleString()}</div>
                    <div>הכנסות חודש ${monthName}</div>
                </div>
                <div class="card expenses">
                    <h3>סך הוצאות</h3>
                    <div class="amount">₪${data.totalExpenses.toLocaleString()}</div>
                    <div>הוצאות חודש ${monthName}</div>
                </div>
                <div class="card ${data.balance >= 0 ? 'revenue' : 'expenses'}">
                    <h3>יתרה</h3>
                    <div class="amount">${data.balance >= 0 ? '' : '-'}₪${Math.abs(data.balance).toLocaleString()}</div>
                    <div>יתרה חודש ${monthName}</div>
                </div>
                <div class="card pending">
                    <h3>חיובים שנדחו</h3>
                    <div class="amount">₪${data.otherExpenses.deferredCharges.toLocaleString()}</div>
                </div>
            </div>
            
            <div class="tables-container">
                <div class="table-section">
                    <h3>פירוט הכנסות</h3>
                    <table>
                        <thead>
                            <tr><th>מקור הכנסה</th><th>סכום (₪)</th><th>אחוז</th></tr>
                        </thead>
                        <tbody>
                            <tr style="background-color: #f8f9fa; font-weight: bold;">
                                <td colspan="3">1. תרומות קבועות</td>
                            </tr>
                            <tr><td>&nbsp;&nbsp;&nbsp;אשראי</td><td>${data.regularIncome.credit.toLocaleString()}</td><td>${data.totalIncome > 0 ? ((data.regularIncome.credit / data.totalIncome) * 100).toFixed(1) : 0}%</td></tr>
                            <tr><td>&nbsp;&nbsp;&nbsp;בנקאי</td><td>${data.regularIncome.bank.toLocaleString()}</td><td>${data.totalIncome > 0 ? ((data.regularIncome.bank / data.totalIncome) * 100).toFixed(1) : 0}%</td></tr>
                            <tr><td>&nbsp;&nbsp;&nbsp;מזומן</td><td>${data.regularIncome.cash.toLocaleString()}</td><td>${data.totalIncome > 0 ? ((data.regularIncome.cash / data.totalIncome) * 100).toFixed(1) : 0}%</td></tr>
                            <tr><td>&nbsp;&nbsp;&nbsp;העברות</td><td>${data.regularIncome.transfers.toLocaleString()}</td><td>${data.totalIncome > 0 ? ((data.regularIncome.transfers / data.totalIncome) * 100).toFixed(1) : 0}%</td></tr>
                            <tr><td>&nbsp;&nbsp;&nbsp;שקים</td><td>${data.regularIncome.checks.toLocaleString()}</td><td>${data.totalIncome > 0 ? ((data.regularIncome.checks / data.totalIncome) * 100).toFixed(1) : 0}%</td></tr>
                            <tr style="background-color: #f8f9fa; font-weight: bold;">
                                <td colspan="3">2. תרומות מזדמנות</td>
                            </tr>
                            <tr><td>&nbsp;&nbsp;&nbsp;אשראי</td><td>${data.occasionalIncome.credit.toLocaleString()}</td><td>${data.totalIncome > 0 ? ((data.occasionalIncome.credit / data.totalIncome) * 100).toFixed(1) : 0}%</td></tr>
                            <tr><td>&nbsp;&nbsp;&nbsp;מזומן</td><td>${data.occasionalIncome.cash.toLocaleString()}</td><td>${data.totalIncome > 0 ? ((data.occasionalIncome.cash / data.totalIncome) * 100).toFixed(1) : 0}%</td></tr>
                            <tr><td>&nbsp;&nbsp;&nbsp;שקים</td><td>${data.occasionalIncome.checks.toLocaleString()}</td><td>${data.totalIncome > 0 ? ((data.occasionalIncome.checks / data.totalIncome) * 100).toFixed(1) : 0}%</td></tr>
                            <tr><td>&nbsp;&nbsp;&nbsp;בנקאי</td><td>${data.occasionalIncome.bank.toLocaleString()}</td><td>${data.totalIncome > 0 ? ((data.occasionalIncome.bank / data.totalIncome) * 100).toFixed(1) : 0}%</td></tr>
                            <tr><td>&nbsp;&nbsp;&nbsp;העברות</td><td>${data.occasionalIncome.transfers.toLocaleString()}</td><td>${data.totalIncome > 0 ? ((data.occasionalIncome.transfers / data.totalIncome) * 100).toFixed(1) : 0}%</td></tr>
                            <tr class="total-row">
                                <td>סך הכל</td><td>${data.totalIncome.toLocaleString()}</td><td>100%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="table-section">
                    <h3>פירוט הוצאות</h3>
                    <table>
                        <thead>
                            <tr><th>סוג הוצאה</th><th>סכום (₪)</th><th>אחוז</th><th class="arrow-col"></th></tr>
                        </thead>
                        <tbody>
                            <tr><td>סך המלגות</td><td>${data.totalScholarships.toLocaleString()}</td><td>${data.totalExpenses > 0 ? ((data.totalScholarships / data.totalExpenses) * 100).toFixed(1) : 0}%</td><td></td></tr>
                            <tr><td>משכורות</td><td>${data.totalSalaries.toLocaleString()}</td><td>${data.totalExpenses > 0 ? ((data.totalSalaries / data.totalExpenses) * 100).toFixed(1) : 0}%</td><td></td></tr>
                            <tr><td>חוב לפולק</td><td>${data.otherExpenses.debtPolak.toLocaleString()}</td><td>${data.totalExpenses > 0 ? ((data.otherExpenses.debtPolak / data.totalExpenses) * 100).toFixed(1) : 0}%</td><td></td></tr>
                            <tr><td>הוצאות משרד</td><td>${data.totalOffice.toLocaleString()}</td><td>${data.totalExpenses > 0 ? ((data.totalOffice / data.totalExpenses) * 100).toFixed(1) : 0}%</td><td></td></tr>
                            <tr><td>הוצאות פרסום</td><td>${data.otherExpenses.advertising.toLocaleString()}</td><td>${data.totalExpenses > 0 ? ((data.otherExpenses.advertising / data.totalExpenses) * 100).toFixed(1) : 0}%</td><td></td></tr>
                            <tr><td>חוב פסח</td><td>${data.otherExpenses.passoverDebt.toLocaleString()}</td><td>${data.totalExpenses > 0 ? ((data.otherExpenses.passoverDebt / data.totalExpenses) * 100).toFixed(1) : 0}%</td><td></td></tr>
                            <tr><td>תוכנות</td><td>${data.otherExpenses.software.toLocaleString()}</td><td>${data.totalExpenses > 0 ? ((data.otherExpenses.software / data.totalExpenses) * 100).toFixed(1) : 0}%</td><td></td></tr>
                            <tr><td>עמלות</td><td>${data.otherExpenses.commissions.toLocaleString()}</td><td>${data.totalExpenses > 0 ? ((data.otherExpenses.commissions / data.totalExpenses) * 100).toFixed(1) : 0}%</td><td></td></tr>
                            ${data.customExpenses.map(expense => {
                                if (expense.subExpenses.length > 0) {
                                    const cleanName = expense.name.replace(/[^a-zA-Z0-9]/g, '');
                                    return `
                                        <tr class="expandable-row" onclick="toggleDetails('${cleanName}')">
                                            <td>${expense.name}</td>
                                            <td>${expense.amount.toLocaleString()}</td>
                                            <td>${data.totalExpenses > 0 ? ((expense.amount / data.totalExpenses) * 100).toFixed(1) : 0}%</td>
                                            <td class="arrow-col">▶</td>
                                        </tr>
                                        ${expense.subExpenses.map((subExp, index) => `
                                            <tr class="detail-row" id="${cleanName}-${index + 1}">
                                                <td>&nbsp;&nbsp;&nbsp;${subExp.name}</td>
                                                <td>${subExp.amount.toLocaleString()}</td>
                                                <td>${expense.amount > 0 ? ((subExp.amount / expense.amount) * 100).toFixed(1) : 0}%</td>
                                                <td></td>
                                            </tr>
                                        `).join('')}
                                    `;
                                } else {
                                    return `<tr><td>${expense.name}</td><td>${expense.amount.toLocaleString()}</td><td>${data.totalExpenses > 0 ? ((expense.amount / data.totalExpenses) * 100).toFixed(1) : 0}%</td><td></td></tr>`;
                                }
                            }).join('')}
                            <tr class="total-row">
                                <td>סך הכל</td><td>${data.totalExpenses.toLocaleString()}</td><td>100%</td><td></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script>
        function toggleDetails(category) {
            const detailRows = document.querySelectorAll('[id^="' + category + '-"]');
            const expandableRows = document.querySelectorAll('.expandable-row');
            let expandableRow = null;
            
            expandableRows.forEach(row => {
                if (row.cells[0].textContent.replace(/[^a-zA-Z0-9]/g, '') === category) {
                    expandableRow = row;
                }
            });
            
            if (!expandableRow) return;
            
            const arrow = expandableRow.querySelector('.arrow-col');
            
            let isVisible = false;
            detailRows.forEach(row => {
                if (row.classList.contains('show')) {
                    isVisible = true;
                }
            });
            
            if (isVisible) {
                detailRows.forEach(row => {
                    row.classList.remove('show');
                });
                if (arrow) arrow.textContent = '▶';
            } else {
                detailRows.forEach(row => {
                    row.classList.add('show');
                });
                if (arrow) arrow.textContent = '▼';
            }
        }
    </script>
</body>
</html>`;
        }

        // יצירת דוח מפורט
        function generateDetailedReport(data) {
            const monthName = monthNames[data.month];
            
            return `<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <title>דוח מפורט - חודש ${monthName}</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { margin: 0; font-size: 2.5em; font-weight: 300; }
        .content { padding: 40px; }
        .section-divider { display: flex; align-items: center; margin: 40px 0; gap: 20px; }
        .divider-line { flex: 1; height: 2px; background: linear-gradient(90deg, #e9ecef, #6c757d, #e9ecef); }
        .divider-text { padding: 15px 30px; color: white; border-radius: 25px; font-weight: 600; font-size: 1.1em; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .pagi-divider { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
        .merkantil-divider { background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%); }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .summary-card { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 15px; padding: 25px; text-align: center; position: relative; overflow: hidden; }
        .summary-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 5px; }
        .pagi-income::before { background: linear-gradient(90deg, #28a745, #20c997); }
        .pagi-expenses::before { background: linear-gradient(90deg, #dc3545, #fd7e14); }
        .merkantil-income::before { background: linear-gradient(90deg, #17a2b8, #20c997); }
        .summary-card h4 { margin: 0 0 10px 0; color: #495057; font-size: 1em; }
        .summary-card .amount { font-size: 1.8em; font-weight: bold; margin: 10px 0; }
        .pagi-income .amount { color: #28a745; }
        .pagi-expenses .amount { color: #dc3545; }
        .merkantil-income .amount { color: #17a2b8; }
        .tables-container { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 40px; }
        .table-section { background: #f8f9fa; border-radius: 15px; padding: 25px; border: 2px solid #e9ecef; }
        .table-section h3 { margin: 0 0 20px 0; color: #495057; font-size: 1.3em; padding-bottom: 10px; border-bottom: 3px solid #dee2e6; }
        .income-section h3 { color: #28a745; border-bottom-color: #28a745; }
        .expenses-section h3 { color: #dc3545; border-bottom-color: #dc3545; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        th, td { padding: 15px; text-align: right; border-bottom: 1px solid #e9ecef; }
        th { background: linear-gradient(135deg, #495057 0%, #6c757d 100%); color: white; font-weight: 600; }
        .subcategory-row td { padding-right: 30px; font-size: 0.95em; color: #666; }
        .total-row { background: #dee2e6 !important; font-weight: bold; border-top: 2px solid #adb5bd; color: #495057; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>דוח הכנסות והוצאות</h1>
            <div class="period">חודש ${monthName} ${data.year}</div>
        </div>
        
        <div class="content">
            <div class="section-divider">
                <div class="divider-line"></div>
                <div class="divider-text pagi-divider">בנק פאגי</div>
                <div class="divider-line"></div>
            </div>
            
            <div class="summary-cards">
                <div class="summary-card pagi-income">
                    <h4>סך הכנסות בנק פאגי</h4>
                    <div class="amount">₪${(data.banks.pagiKeren.income + data.banks.pagiBeit.income).toLocaleString()}</div>
                </div>
                <div class="summary-card pagi-expenses">
                    <h4>סך הוצאות בנק פאגי</h4>
                    <div class="amount">₪${(data.banks.pagiKeren.scholarships + data.banks.pagiKeren.salaries + data.banks.pagiBeit.expenses).toLocaleString()}</div>
                </div>
                <div class="summary-card">
                    <h4>יתרה בנק פאגי</h4>
                    <!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מחולל דוחות כספיים</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .content {
            padding: 40px;
        }
        
        .form-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }
        
        .form-section h2 {
            color: #495057;
            margin: 0 0 25px 0;
            font-size: 1.4em;
            padding-bottom: 10px;
            border-bottom: 3px solid #dee2e6;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        
        input[type="number"], input[type="text"], select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }
        
        input[type="number"]:focus, input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .subsection {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid #dee2e6;
        }
        
        .subsection h3 {
            margin: 0 0 15px 0;
            color: #6c757d;
            font-size: 1.1em;
        }
        
        .btn {
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            color: white;
        }
        
        .btn-sample {
            background: linear-gradient(135deg, #6f42c1, #e83e8c);
            box-shadow: 0 8px 20px rgba(111, 66, 193, 0.3);
        }
        
        .btn-preview {
            background: linear-gradient(135deg, #17a2b8, #20c997);
            box-shadow: 0 8px 20px rgba(23, 162, 184, 0.3);
        }
        
        .btn-generate {
            background: linear-gradient(135deg, #28a745, #20c997);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.2);
        }
        
        .button-container {
            text-align: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e9ecef;
        }
        
        .output-area {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            border: 2px solid #e9ecef;
            display: none;
        }
        
        .file-output {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .file-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .download-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .download-btn:hover {
            background: #0056b3;
        }
        
        .code-preview {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
            color: #6c757d;
        }
        
        .custom-expense-item {
            background: #fff;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }
        
        .custom-expense-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            gap: 15px;
        }
        
        .custom-expense-header input {
            flex: 1;
        }
        
        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            min-width: 60px;
        }
        
        .remove-btn:hover {
            background: #c82333;
        }
        
        .add-sub-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            margin-top: 10px;
        }
        
        .add-sub-btn:hover {
            background: #138496;
        }
        
        .sub-expenses {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }
        
        .sub-expense-item {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .sub-expense-item input {
            margin: 0;
        }
        
        .sub-expense-name {
            flex: 2;
        }
        
        .sub-expense-amount {
            flex: 1;
        }
        
        .remove-sub-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.7em;
        }
        
        .remove-sub-btn:hover {
            background: #5a6268;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>מחולל דוחות כספיים אוטומטי</h1>
            <p>הזן נתונים חודשיים וקבל דוחות מעוצבים מוכנים</p>
        </div>
        
        <div class="content">
            <!-- פרטי החודש -->
            <div class="form-section">
                <h2>פרטי החודש</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="month">חודש:</label>
                        <select id="month" required>
                            <option value="">בחר חודש</option>
                            <option value="1">ינואר</option>
                            <option value="2">פברואר</option>
                            <option value="3">מרץ</option>
                            <option value="4">אפריל</option>
                            <option value="5">מאי</option>
                            <option value="6">יוני</option>
                            <option value="7">יולי</option>
                            <option value="8">אוגוסט</option>
                            <option value="9">ספטמבר</option>
                            <option value="10">אוקטובר</option>
                            <option value="11">נובמבר</option>
                            <option value="12">דצמבר</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="year">שנה:</label>
                        <input type="number" id="year" value="2025" min="2020" max="2030" required>
                    </div>
                    <div class="form-group">
                        <label for="totalDonors">סך תורמים:</label>
                        <input type="number" id="totalDonors" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="totalRecipients">סך מקבלי מלגות:</label>
                        <input type="number" id="totalRecipients" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="totalScholarships">סך מלגות שחולקו (₪):</label>
                        <input type="number" id="totalScholarships" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="previousBalance">יתרת מלגות קודמות (₪):</label>
                        <input type="number" id="previousBalance" min="0" required>
                    </div>
                </div>
            </div>

            <!-- הכנסות -->
            <div class="form-section">
                <h2>הכנסות</h2>
                
                <div class="subsection">
                    <h3>תרומות קבועות</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="regularCredit">אשראי (₪):</label>
                            <input type="number" id="regularCredit" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="regularBank">בנקאי (₪):</label>
                            <input type="number" id="regularBank" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="regularCash">מזומן (₪):</label>
                            <input type="number" id="regularCash" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="regularTransfers">העברות (₪):</label>
                            <input type="number" id="regularTransfers" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="regularChecks">שקים (₪):</label>
                            <input type="number" id="regularChecks" min="0" value="0">
                        </div>
                    </div>
                </div>
                
                <div class="subsection">
                    <h3>תרומות מזדמנות</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="occasionalCredit">אשראי (₪):</label>
                            <input type="number" id="occasionalCredit" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="occasionalBank">בנקאי (₪):</label>
                            <input type="number" id="occasionalBank" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="occasionalCash">מזומן (₪):</label>
                            <input type="number" id="occasionalCash" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="occasionalTransfers">העברות (₪):</label>
                            <input type="number" id="occasionalTransfers" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="occasionalChecks">שקים (₪):</label>
                            <input type="number" id="occasionalChecks" min="0" value="0">
                        </div>
                    </div>
                </div>
            </div>

            <!-- הוצאות -->
            <div class="form-section">
                <h2>הוצאות</h2>
                
                <div class="subsection">
                    <h3>משכורות</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="salaryAbraham">אברהם פלק (₪):</label>
                            <input type="number" id="salaryAbraham" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="salaryShlomo">שלמה מאיר קליין (₪):</label>
                            <input type="number" id="salaryShlomo" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="salaryNachman">נחמן אייזנבאך (₪):</label>
                            <input type="number" id="salaryNachman" min="0" value="0">
                        </div>
                    </div>
                </div>
                
                <div class="subsection">
                    <h3>הוצאות משרד</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="officeRent">שכירות (₪):</label>
                            <input type="number" id="officeRent" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="officeUtilities">חשמל-מים-ועד (₪):</label>
                            <input type="number" id="officeUtilities" min="0" value="0">
                        </div>
                    </div>
                </div>
                
                <div class="subsection">
                    <h3>הוצאות אחרות</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="debtPolak">חוב לפולק (₪):</label>
                            <input type="number" id="debtPolak" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="advertising">הוצאות פרסום (₪):</label>
                            <input type="number" id="advertising" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="passoverDebt">חוב פסח (₪):</label>
                            <input type="number" id="passoverDebt" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="software">תוכנות (₪):</label>
                            <input type="number" id="software" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="commissions">עמלות (₪):</label>
                            <input type="number" id="commissions" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="deferredCharges">חיובים שנדחו (₪):</label>
                            <input type="number" id="deferredCharges" min="0" value="0">
                        </div>
                    </div>
                </div>
                
                <!-- הוצאות מותאמות אישית -->
                <div class="subsection">
                    <h3>הוצאות מותאמות אישית 
                        <button type="button" class="btn" style="background: #28a745; color: white; padding: 8px 16px; margin-right: 15px; font-size: 0.9em;" onclick="addCustomExpense()">+ הוסף הוצאה</button>
                    </h3>
                    <div id="customExpenses">
                        <!-- הוצאות מותאמות יתווספו כאן -->
                    </div>
                </div>
            </div>

            <!-- נתוני בנקים -->
            <div class="form-section">
                <h2>פירוט לפי בנקים</h2>
                
                <div class="subsection">
                    <h3>בנק פאגי - קרן התורה</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="pagiKerenIncome">הכנסות קרן התורה (₪):</label>
                            <input type="number" id="pagiKerenIncome" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="pagiKerenScholarships">מלגות קרן התורה (₪):</label>
                            <input type="number" id="pagiKerenScholarships" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="pagiKerenSalaries">משכורות קרן התורה (₪):</label>
                            <input type="number" id="pagiKerenSalaries" min="0" value="0">
                        </div>
                    </div>
                </div>
                
                <div class="subsection">
                    <h3>בנק פאגי - בית המדרש</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="pagiBeitIncome">הכנסות בית המדרש (₪):</label>
                            <input type="number" id="pagiBeitIncome" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="pagiBeitExpenses">הוצאות בית המדרש (₪):</label>
                            <input type="number" id="pagiBeitExpenses" min="0" value="0">
                        </div>
                    </div>
                </div>
                
                <div class="subsection">
                    <h3>בנק מרכנתיל</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="merkantilIncome">הכנסות מרכנתיל (₪):</label>
                            <input type="number" id="merkantilIncome" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="merkantilScholarships">מלגות מרכנתיל (₪):</label>
                            <input type="number" id="merkantilScholarships" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="merkantilSalaries">משכורות מרכנתיל (₪):</label>
                            <input type="number" id="merkantilSalaries" min="0" value="0">
                        </div>
                    </div>
                </div>
            </div>

            <div class="button-container">
                <button type="button" class="btn btn-sample" onclick="loadSampleData()">טען נתונים לדוגמה (מאי 2025)</button>
                <button type="button" class="btn btn-preview" onclick="previewData()">תצוגה מקדימה</button>
                <button type="button" class="btn btn-generate" onclick="generateReports()">צור דוחות</button>
            </div>

            <div id="outputArea" class="output-area">
                <h3>דוחות שנוצרו</h3>
                <div id="generatedFiles"></div>
            </div>
        </div>
    </div>

    <script>
        // משתנים גלובליים
        let generatedFilesData = [];
        let customExpenseCounter = 0;
        
        const monthNames = ['', 'ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];

        // הוספת הוצאה מותאמת אישית
        function addCustomExpense() {
            customExpenseCounter++;
            const customExpensesContainer = document.getElementById('customExpenses');
            
            const expenseDiv = document.createElement('div');
            expenseDiv.className = 'custom-expense-item';
            expenseDiv.id = `custom-expense-${customExpenseCounter}`;
            
            expenseDiv.innerHTML = `
                <div class="custom-expense-header">
                    <div class="form-group" style="flex: 2; margin: 0;">
                        <label>שם ההוצאה:</label>
                        <input type="text" id="customExpenseName-${customExpenseCounter}" placeholder="לדוגמה: הוצאות נסיעות">
                    </div>
                    <div class="form-group" style="flex: 1; margin: 0;">
                        <label>סכום כולל (₪):</label>
                        <input type="number" id="customExpenseAmount-${customExpenseCounter}" min="0" value="0">
                    </div>
                    <button type="button" class="remove-btn" onclick="removeCustomExpense(${customExpenseCounter})">מחק</button>
                </div>
                <button type="button" class="add-sub-btn" onclick="addSubExpense(${customExpenseCounter})">+ הוסף פירוט</button>
                <div class="sub-expenses" id="subExpenses-${customExpenseCounter}">
                    <!-- תתי הוצאות יתווספו כאן -->
                </div>
            `;
            
            customExpensesContainer.appendChild(expenseDiv);
        }

        // הסרת הוצאה מותאמת אישית
        function removeCustomExpense(id) {
            const expenseDiv = document.getElementById(`custom-expense-${id}`);
            if (expenseDiv) {
                expenseDiv.remove();
            }
        }

        // הוספת תת הוצאה
        function addSubExpense(parentId) {
            const subExpensesContainer = document.getElementById(`subExpenses-${parentId}`);
            const subExpenseId = `${parentId}-${Date.now()}`;
            
            const subExpenseDiv = document.createElement('div');
            subExpenseDiv.className = 'sub-expense-item';
            subExpenseDiv.id = `sub-expense-${subExpenseId}`;
            
            subExpenseDiv.innerHTML = `
                <input type="text" class="sub-expense-name" placeholder="פירוט" id="subExpenseName-${subExpenseId}">
                <input type="number" class="sub-expense-amount" placeholder="סכום" min="0" value="0" id="subExpenseAmount-${subExpenseId}">
                <button type="button" class="remove-sub-btn" onclick="removeSubExpense('${subExpenseId}')">×</button>
            `;
            
            subExpensesContainer.appendChild(subExpenseDiv);
        }

        // הסרת תת הוצאה
        function removeSubExpense(id) {
            const subExpenseDiv = document.getElementById(`sub-expense-${id}`);
            if (subExpenseDiv) {
                subExpenseDiv.remove();
            }
        }

        // טעינת נתונים לדוגמה
        function loadSampleData() {
            console.log('טוען נתונים לדוגמה...');
            
            document.getElementById('month').value = '5';
            document.getElementById('year').value = '2025';
            document.getElementById('totalDonors').value = '424';
            document.getElementById('totalRecipients').value = '178';
            document.getElementById('totalScholarships').value = '103091';
            document.getElementById('previousBalance').value = '68744';
            
            document.getElementById('regularCredit').value = '64204';
            document.getElementById('regularBank').value = '33846';
            document.getElementById('regularCash').value = '8450';
            document.getElementById('regularTransfers').value = '2820';
            document.getElementById('regularChecks').value = '0';
            
            document.getElementById('salaryAbraham').value = '9400';
            document.getElementById('salaryShlomo').value = '9400';
            document.getElementById('salaryNachman').value = '1750';
            
            document.getElementById('officeRent').value = '2550';
            document.getElementById('officeUtilities').value = '450';
            
            document.getElementById('debtPolak').value = '11100';
            document.getElementById('advertising').value = '3500';
            document.getElementById('passoverDebt').value = '3500';
            document.getElementById('software').value = '1729';
            document.getElementById('commissions').value = '582';
            document.getElementById('deferredCharges').value = '7544';
            
            document.getElementById('pagiKerenIncome').value = '75450';
            document.getElementById('pagiKerenScholarships').value = '79974';
            document.getElementById('pagiKerenSalaries').value = '8750';
            
            document.getElementById('pagiBeitIncome').value = '17921';
            document.getElementById('pagiBeitExpenses').value = '27036';
            
            document.getElementById('merkantilIncome').value = '40716';
            document.getElementById('merkantilScholarships').value = '21217';
            document.getElementById('merkantilSalaries').value = '7000';
            
            alert('נתונים לדוגמה נטענו בהצלחה! כעת לחץ על "צור דוחות"');
        }

        // תצוגה מקדימה
        function previewData() {
            console.log('מציג תצוגה מקדימה...');
            const data = collectFormData();
            
            if (!data.month || !data.year) {
                alert('נא למלא את פרטי החודש והשנה');
                return;
            }
            
            const monthName = monthNames[data.month];
            const summary = `תצוגה מקדימה:\n\nחודש: ${monthName} ${data.year}\nסך הכנסות: ₪${data.totalIncome.toLocaleString()}\nסך הוצאות: ₪${data.totalExpenses.toLocaleString()}\nיתרה: ${data.balance >= 0 ? '' : '-'}₪${Math.abs(data.balance).toLocaleString()}`;
            
            alert(summary);
        }

        // איסוף נתונים מהטופס
        function collectFormData() {
            const month = parseInt(document.getElementById('month').value) || 0;
            const year = parseInt(document.getElementById('year').value) || 0;
            const totalDonors = parseInt(document.getElementById('totalDonors').value) || 0;
            const totalRecipients = parseInt(document.getElementById('totalRecipients').value) || 0;
            const totalScholarships = parseInt(document.getElementById('totalScholarships').value) || 0;
            const previousBalance = parseInt(document.getElementById('previousBalance').value) || 0;

            const regularIncome = {
                credit: parseInt(document.getElementById('regularCredit').value) || 0,
                bank: parseInt(document.getElementById('regularBank').value) || 0,
                cash: parseInt(document.getElementById('regularCash').value) || 0,
                transfers: parseInt(document.getElementById('regularTransfers').value) || 0,
                checks: parseInt(document.getElementById('regularChecks').value) || 0
            };

            const occasionalIncome = {
                credit: parseInt(document.getElementById('occasionalCredit').value) || 0,
                bank: parseInt(document.getElementById('occasionalBank').value) || 0,
                cash: parseInt(document.getElementById('occasionalCash').value) || 0,
                transfers: parseInt(document.getElementById('occasionalTransfers').value) || 0,
                checks: parseInt(document.getElementById('occasionalChecks').value) || 0
            };

            const salaries = {
                abraham: parseInt(document.getElementById('salaryAbraham').value) || 0,
                shlomo: parseInt(document.getElementById('salaryShlomo').value) || 0,
                nachman: parseInt(document.getElementById('salaryNachman').value) || 0
            };

            const office = {
                rent: parseInt(document.getElementById('officeRent').value) || 0,
                utilities: parseInt(document.getElementById('officeUtilities').value) || 0
        };

            const otherExpenses = {
                debtPolak: parseInt(document.getElementById('debtPolak').value) || 0,
                advertising: parseInt(document.getElementById('advertising').value) || 0,
                passoverDebt: parseInt(document.getElementById('passoverDebt').value) || 0,
                software: parseInt(document.getElementById('software').value) || 0,
                commissions: parseInt(document.getElementById('commissions').value) || 0,
                deferredCharges: parseInt(document.getElementById('deferredCharges').value) || 0
            };

// איסוף הוצאות מותאמות אישית
const customExpenses = [];
const customExpenseItems = document.querySelectorAll('.custom-expense-item');

customExpenseItems.forEach(item => {
    const id = item.id.split('-')[2];
    const nameElement = document.getElementById(`customExpenseName-${id}`);
    const amountElement = document.getElementById(`customExpenseAmount-${id}`);
    
    if (nameElement && amountElement && nameElement.value.trim()) {
        const expense = {
            name: nameElement.value.trim(),
            amount: parseInt(amountElement.value) || 0,
            subExpenses: []
        };
        
        // איסוף תתי הוצאות
        const subExpenseItems = item.querySelectorAll('.sub-expense-item');
        subExpenseItems.forEach(subItem => {
            const subId = subItem.id.split('-')[2] + '-' + subItem.id.split('-')[3];
            const subNameElement = document.getElementById(`subExpenseName-${subId}`);
            const subAmountElement = document.getElementById(`subExpenseAmount-${subId}`);
            
            if (subNameElement && subAmountElement && subNameElement.value.trim()) {
                expense.subExpenses.push({
                    name: subNameElement.value.trim(),
                    amount: parseInt(subAmountElement.value) || 0
                });
            }
        });
        
        customExpenses.push(expense);
    }
});

const banks = {
    pagiKeren: {
        income: parseInt(document.getElementById('pagiKerenIncome').value) || 0,
        scholarships: parseInt(document.getElementById('pagiKerenScholarships').value) || 0,
        salaries: parseInt(document.getElementById('pagiKerenSalaries').value) || 0
    },
    pagiBeit: {
        income: parseInt(document.getElementById('pagiBeitIncome').value) || 0,
        expenses: parseInt(document.getElementById('pagiBeitExpenses').value) || 0
    },
    merkantil: {
        income: parseInt(document.getElementById('merkantilIncome').value) || 0,
        scholarships: parseInt(document.getElementById('merkantilScholarships').value) || 0,
        salaries: parseInt(document.getElementById('merkantilSalaries').value) || 0
    }
};

// חישובים
const totalRegularIncome = Object.values(regularIncome).reduce((a, b) => a + b, 0);
const totalOccasionalIncome = Object.values(occasionalIncome).reduce((a, b) => a + b, 0);
const totalIncome = totalRegularIncome + totalOccasionalIncome;

const totalSalaries = Object.values(salaries).reduce((a, b) => a + b, 0);
const totalOffice = Object.values(office).reduce((a, b) => a + b, 0);
const totalOther = Object.values(otherExpenses).reduce((a, b) => a + b, 0);
const totalCustomExpenses = customExpenses.reduce((sum, exp) => sum + exp.amount, 0);
const totalExpenses = totalScholarships + totalSalaries + totalOffice + totalOther + totalCustomExpenses;

const balance = totalIncome - totalExpenses;

return {
    month, year, totalDonors, totalRecipients, totalScholarships, previousBalance,
    regularIncome, occasionalIncome, salaries, office, otherExpenses, customExpenses, banks,
    totalIncome, totalExpenses, balance,
    totalRegularIncome, totalOccasionalIncome, totalSalaries, totalOffice, totalOther, totalCustomExpenses
};
}

        // יצירת דוחות
        function generateReports() {
            console.log('מתחיל ליצור דוחות...');
            const data = collectFormData();
            
            if (!data.month || !data.year) {
                alert('נא למלא את פרטי החודש והשנה');
                return;
            }

            const fileName1 = `${data.year}${data.month.toString().padStart(2, '0')}-1.html`;
            const fileName2 = `${data.year}${data.month.toString().padStart(2, '0')}-2.html`;
            
            const mainReport = generateMainReport(data);
            const detailedReport = generateDetailedReport(data);

            generatedFilesData = [
                { name: fileName1, content: mainReport, title: 'דוח כללי' },
                { name: fileName2, content: detailedReport, title: 'דוח מפורט לפי בנקים' }
            ];

            displayGeneratedFiles();
        }

        // יצירת דוח ראשי
        function generateMainReport(data) {
            const monthName = monthNames[data.month];
            
            return `<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <title>דוח הכנסות והוצאות - חודש ${data.month}</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { margin: 0; font-size: 2.5em; font-weight: 300; }
        .content { padding: 40px; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-bottom: 40px; }
        .card { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 15px; padding: 30px; text-align: center; position: relative; overflow: hidden; }
        .card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 5px; }
        .card.info::before { background: linear-gradient(90deg, #17a2b8, #20c997); }
        .card.pending::before { background: linear-gradient(90deg, #ffc107, #fd7e14); }
        .card.revenue::before { background: linear-gradient(90deg, #28a745, #20c997); }
        .card.expenses::before { background: linear-gradient(90deg, #dc3545, #fd7e14); }
        .card h3 { margin: 0 0 15px 0; color: #495057; font-size: 1.1em; font-weight: 600; }
        .card .amount { font-size: 2.2em; font-weight: bold; margin: 10px 0; }
        .card.revenue .amount { color: #28a745; }
        .card.expenses .amount { color: #dc3545; }
        .card.info .amount { color: #17a2b8; }
        .card.pending .amount { color: #ffc107; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        th, td { padding: 15px; text-align: right; border-bottom: 1px solid #e9ecef; }
        th { background: linear-gradient(135deg, #495057 0%, #6c757d 100%); color: white; font-weight: 600; }
        .total-row { background: #e9ecef !important; font-weight: bold; border-top: 2px solid #dee2e6; }
        .expandable-row { cursor: pointer; transition: background-color 0.2s ease; }
        .expandable-row:hover { background: #e3f2fd !important; }
        .detail-row { display: none; background: #f0f8ff !important; }
        .detail-row.show { display: table-row; }
        .detail-row td { padding-right: 40px; font-size: 0.9em; color: #666; border-bottom: 1px dashed #ddd; }
        .arrow-col { width: 30px; text-align: center; color: #6c757d; font-weight: normal; font-size: 0.8em; }
        .tables-container { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 40px; }
        .table-section { background: #f8f9fa; border-radius: 15px; padding: 25px; border: 2px solid #e9ecef; }
        .table-section h3 { margin: 0 0 20px 0; color: #495057; font-size: 1.3em; padding-bottom: 10px; border-bottom: 3px solid #dee2e6; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>דוח הכנסות והוצאות</h1>
            <div class="period">חודש ${monthName} ${data.year}</div>
        </div>
        
        <div class="content">
            <div class="summary-cards">
                <div class="card info">
                    <h3>סך תורמים</h3>
                    <div class="amount">${data.totalDonors}</div>
                    <div>תורמים פעילים</div>
                </div>
                <div class="card info">
                    <h3>סך אברכים המקבלים מלגה</h3>
                    <div class="amount">${data.totalRecipients}</div>
                    <div>מקבלי מלגות</div>
                </div>
                <div class="card pending">
                    <h3>חולקו מלגות על סך</h3>
                    <div class="amount">₪${data.totalScholarships.toLocaleString()}</div>
                </div>
                <div class="card pending">
                    <h3>יתרת מלגות קודמות</h3>
                    <div class="amount">₪${data.previousBalance.toLocaleString()}</div>
                    <div>שלא נגבו</div>
                </div>
            </div>
            
            <div class="summary-cards">
                <div class="card revenue">
                    <h3>סך הכנסות</h3>
                    <div class="amount">₪${data.totalIncome.toLocaleString()}</div>
                    <div>הכנסות חודש ${monthName}</div>
                </div>
                <div class="card expenses">
                    <h3>סך הוצאות</h3>
                    <div class="amount">₪${data.totalExpenses.toLocaleString()}</div>
                    <div>הוצאות חודש ${monthName}</div>
                </div>
                <div class="card ${data.balance >= 0 ? 'revenue' : 'expenses'}">
                    <h3>יתרה</h3>
                    <div class="amount">${data.balance >= 0 ? '' : '-'}₪${Math.abs(data.balance).toLocaleString()}</div>
                    <div>יתרה חודש ${monthName}</div>
                </div>
                <div class="card pending">
                    <h3>חיובים שנדחו</h3>
                    <div class="amount">₪${data.otherExpenses.deferredCharges.toLocaleString()}</div>
                </div>
            </div>
            
            <div class="tables-container">
                <div class="table-section">
                    <h3>פירוט הכנסות</h3>
                    <table>
                        <thead>
                            <tr><th>מקור הכנסה</th><th>סכום (₪)</th><th>אחוז</th></tr>
                        </thead>
                        <tbody>
                            <tr style="background-color: #f8f9fa; font-weight: bold;">
                                <td colspan="3">1. תרומות קבועות</td>
                            </tr>
                            <tr><td>&nbsp;&nbsp;&nbsp;אשראי</td><td>${data.regularIncome.credit.toLocaleString()}</td><td>${data.totalIncome > 0 ? ((data.regularIncome.credit / data.totalIncome) * 100).toFixed(1) : 0}%</td></tr>
                            <tr><td>&nbsp;&nbsp;&nbsp;בנקאי</td><td>${data.regularIncome.bank.toLocaleString()}</td><td>${data.totalIncome > 0 ? ((data.regularIncome.bank / data.totalIncome) * 100).toFixed(1) : 0}%</td></tr>
                            <tr><td>&nbsp;&nbsp;&nbsp;מזומן</td><td>${data.regularIncome.cash.toLocaleString()}</td><td>${data.totalIncome > 0 ? ((data.regularIncome.cash / data.totalIncome) * 100).toFixed(1) : 0}%</td></tr>
                            <tr><td>&nbsp;&nbsp;&nbsp;העברות</td><td>${data.regularIncome.transfers.toLocaleString()}</td><td>${data.totalIncome > 0 ? ((data.regularIncome.transfers / data.totalIncome) * 100).toFixed(1) : 0}%</td></tr>
                            <tr><td>&nbsp;&nbsp;&nbsp;שקים</td><td>${data.regularIncome.checks.toLocaleString()}</td><td>${data.totalIncome > 0 ? ((data.regularIncome.checks / data.totalIncome) * 100).toFixed(1) : 0}%</td></tr>
                            <tr style="background-color: #f8f9fa; font-weight: bold;">
                                <td colspan="3">2. תרומות מזדמנות</td>
                            </tr>
                            <tr><td>&nbsp;&nbsp;&nbsp;אשראי</td><td>${data.occasionalIncome.credit.toLocaleString()}</td><td>${data.totalIncome > 0 ? ((data.occasionalIncome.credit / data.totalIncome) * 100).toFixed(1) : 0}%</td></tr>
                            <tr><td>&nbsp;&nbsp;&nbsp;מזומן</td><td>${data.occasionalIncome.cash.toLocaleString()}</td><td>${data.totalIncome > 0 ? ((data.occasionalIncome.cash / data.totalIncome) * 100).toFixed(1) : 0}%</td></tr>
                            <tr><td>&nbsp;&nbsp;&nbsp;שקים</td><td>${data.occasionalIncome.checks.toLocaleString()}</td><td>${data.totalIncome > 0 ? ((data.occasionalIncome.checks / data.totalIncome) * 100).toFixed(1) : 0}%</td></tr>
                            <tr><td>&nbsp;&nbsp;&nbsp;בנקאי</td><td>${data.occasionalIncome.bank.toLocaleString()}</td><td>${data.totalIncome > 0 ? ((data.occasionalIncome.bank / data.totalIncome) * 100).toFixed(1) : 0}%</td></tr>
                            <tr><td>&nbsp;&nbsp;&nbsp;העברות</td><td>${data.occasionalIncome.transfers.toLocaleString()}</td><td>${data.totalIncome > 0 ? ((data.occasionalIncome.transfers / data.totalIncome) * 100).toFixed(1) : 0}%</td></tr>
                            <tr class="total-row">
                                <td>סך הכל</td><td>${data.totalIncome.toLocaleString()}</td><td>100%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="table-section">
                    <h3>פירוט הוצאות</h3>
                    <table>
                        <thead>
                            <tr><th>סוג הוצאה</th><th>סכום (₪)</th><th>אחוז</th><th class="arrow-col"></th></tr>
                        </thead>
                        <tbody>
                            <tr><td>סך המלגות</td><td>${data.totalScholarships.toLocaleString()}</td><td>${data.totalExpenses > 0 ? ((data.totalScholarships / data.totalExpenses) * 100).toFixed(1) : 0}%</td><td></td></tr>
                            <tr><td>משכורות</td><td>${data.totalSalaries.toLocaleString()}</td><td>${data.totalExpenses > 0 ? ((data.totalSalaries / data.totalExpenses) * 100).toFixed(1) : 0}%</td><td></td></tr>
                            <tr><td>חוב לפולק</td><td>${data.otherExpenses.debtPolak.toLocaleString()}</td><td>${data.totalExpenses > 0 ? ((data.otherExpenses.debtPolak / data.totalExpenses) * 100).toFixed(1) : 0}%</td><td></td></tr>
                            <tr><td>הוצאות משרד</td><td>${data.totalOffice.toLocaleString()}</td><td>${data.totalExpenses > 0 ? ((data.totalOffice / data.totalExpenses) * 100).toFixed(1) : 0}%</td><td></td></tr>
                            <tr><td>הוצאות פרסום</td><td>${data.otherExpenses.advertising.toLocaleString()}</td><td>${data.totalExpenses > 0 ? ((data.otherExpenses.advertising / data.totalExpenses) * 100).toFixed(1) : 0}%</td><td></td></tr>
                            <tr><td>חוב פסח</td><td>${data.otherExpenses.passoverDebt.toLocaleString()}</td><td>${data.totalExpenses > 0 ? ((data.otherExpenses.passoverDebt / data.totalExpenses) * 100).toFixed(1) : 0}%</td><td></td></tr>
                            <tr><td>תוכנות</td><td>${data.otherExpenses.software.toLocaleString()}</td><td>${data.totalExpenses > 0 ? ((data.otherExpenses.software / data.totalExpenses) * 100).toFixed(1) : 0}%</td><td></td></tr>
                            <tr><td>עמלות</td><td>${data.otherExpenses.commissions.toLocaleString()}</td><td>${data.totalExpenses > 0 ? ((data.otherExpenses.commissions / data.totalExpenses) * 100).toFixed(1) : 0}%</td><td></td></tr>
                            ${data.customExpenses.map(expense => {
                                if (expense.subExpenses.length > 0) {
                                    const cleanName = expense.name.replace(/[^a-zA-Z0-9]/g, '');
                                    return `
                                        <tr class="expandable-row" onclick="toggleDetails('${cleanName}')">
                                            <td>${expense.name}</td>
                                            <td>${expense.amount.toLocaleString()}</td>
                                            <td>${data.totalExpenses > 0 ? ((expense.amount / data.totalExpenses) * 100).toFixed(1) : 0}%</td>
                                            <td class="arrow-col">▶</td>
                                        </tr>
                                        ${expense.subExpenses.map((subExp, index) => `
                                            <tr class="detail-row" id="${cleanName}-${index + 1}">
                                                <td>&nbsp;&nbsp;&nbsp;${subExp.name}</td>
                                                <td>${subExp.amount.toLocaleString()}</td>
                                                <td>${expense.amount > 0 ? ((subExp.amount / expense.amount) * 100).toFixed(1) : 0}%</td>
                                                <td></td>
                                            </tr>
                                        `).join('')}
                                    `;
                                } else {
                                    return `<tr><td>${expense.name}</td><td>${expense.amount.toLocaleString()}</td><td>${data.totalExpenses > 0 ? ((expense.amount / data.totalExpenses) * 100).toFixed(1) : 0}%</td><td></td></tr>`;
                                }
                            }).join('')}
                            <tr class="total-row">
                                <td>סך הכל</td><td>${data.totalExpenses.toLocaleString()}</td><td>100%</td><td></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script>
        function toggleDetails(category) {
            const detailRows = document.querySelectorAll('[id^="' + category + '-"]');
            const expandableRows = document.querySelectorAll('.expandable-row');
            let expandableRow = null;
            
            expandableRows.forEach(row => {
                if (row.cells[0].textContent.replace(/[^a-zA-Z0-9]/g, '') === category) {
                    expandableRow = row;
                }
            });
            
            if (!expandableRow) return;
            
            const arrow = expandableRow.querySelector('.arrow-col');
            
            let isVisible = false;
            detailRows.forEach(row => {
                if (row.classList.contains('show')) {
                    isVisible = true;
                }
            });
            
            if (isVisible) {
                detailRows.forEach(row => {
                    row.classList.remove('show');
                });
                if (arrow) arrow.textContent = '▶';
            } else {
                detailRows.forEach(row => {
                    row.classList.add('show');
                });
                if (arrow) arrow.textContent = '▼';
            }
        }
    </script>
</body>
</html>`;
        }

        // יצירת דוח מפורט
        function generateDetailedReport(data) {
            const monthName = monthNames[data.month];
            
            return `<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <title>דוח מפורט - חודש ${monthName}</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { margin: 0; font-size: 2.5em; font-weight: 300; }
        .content { padding: 40px; }
        .section-divider { display: flex; align-items: center; margin: 40px 0; gap: 20px; }
        .divider-line { flex: 1; height: 2px; background: linear-gradient(90deg, #e9ecef, #6c757d, #e9ecef); }
        .divider-text { padding: 15px 30px; color: white; border-radius: 25px; font-weight: 600; font-size: 1.1em; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .pagi-divider { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
        .merkantil-divider { background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%); }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .summary-card { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 15px; padding: 25px; text-align: center; position: relative; overflow: hidden; }
        .summary-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 5px; }
        .pagi-income::before { background: linear-gradient(90deg, #28a745, #20c997); }
        .pagi-expenses::before { background: linear-gradient(90deg, #dc3545, #fd7e14); }
        .merkantil-income::before { background: linear-gradient(90deg, #17a2b8, #20c997); }
        .summary-card h4 { margin: 0 0 10px 0; color: #495057; font-size: 1em; }
        .summary-card .amount { font-size: 1.8em; font-weight: bold; margin: 10px 0; }
        .pagi-income .amount { color: #28a745; }
        .pagi-expenses .amount { color: #dc3545; }
        .merkantil-income .amount { color: #17a2b8; }
        .tables-container { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 40px; }
        .table-section { background: #f8f9fa; border-radius: 15px; padding: 25px; border: 2px solid #e9ecef; }
        .table-section h3 { margin: 0 0 20px 0; color: #495057; font-size: 1.3em; padding-bottom: 10px; border-bottom: 3px solid #dee2e6; }
        .income-section h3 { color: #28a745; border-bottom-color: #28a745; }
        .expenses-section h3 { color: #dc3545; border-bottom-color: #dc3545; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        th, td { padding: 15px; text-align: right; border-bottom: 1px solid #e9ecef; }
        th { background: linear-gradient(135deg, #495057 0%, #6c757d 100%); color: white; font-weight: 600; }
        .subcategory-row td { padding-right: 30px; font-size: 0.95em; color: #666; }
        .total-row { background: #dee2e6 !important; font-weight: bold; border-top: 2px solid #adb5bd; color: #495057; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>דוח הכנסות והוצאות</h1>
            <div class="period">חודש ${monthName} ${data.year}</div>
        </div>
        
        <div class="content">
            <div class="section-divider">
                <div class="divider-line"></div>
                <div class="divider-text pagi-divider">בנק פאגי</div>
                <div class="divider-line"></div>
            </div>
            
            <div class="summary-cards">
                <div class="summary-card pagi-income">
                    <h4>סך הכנסות בנק פאגי</h4>
                    <div class="amount">₪${(data.banks.pagiKeren.income + data.banks.pagiBeit.income).toLocaleString()}</div>
                </div>
                <div class="summary-card pagi-expenses">
                    <h4>סך הוצאות בנק פאגי</h4>
                    <div class="amount">₪${(data.banks.pagiKeren.scholarships + data.banks.pagiKeren.salaries + data.banks.pagiBeit.expenses).toLocaleString()}</div>
                </div>
                <div class="summary-card">
                    <h4>יתרה בנק פאגי</h4>
                    <div class="amount" style="color: ${((data.banks.pagiKeren.income + data.banks.pagiBeit.income) - (data.banks.pagiKeren.scholarships + data.banks.pagiKeren.salaries + data.banks.pagiBeit.expenses)) >= 0 ? '#28a745' : '#dc3545'};">₪${((data.banks.pagiKeren.income + data.banks.pagiBeit.income) - (data.banks.pagiKeren.scholarships + data.banks.pagiKeren.salaries + data.banks.pagiBeit.expenses)).toLocaleString()}</div>
                </div>
            </div>
            
            <h3 style="background: linear-gradient(135deg, #17a2b8, #20c997); color: white; padding: 15px 25px; border-radius: 10px; margin-bottom: 20px; text-align: center;">קרן התורה</h3>
            
            <div class="summary-cards">
                <div class="summary-card pagi-income">
                    <h4>הכנסות קרן התורה</h4>
                    <div class="amount">₪${data.banks.pagiKeren.income.toLocaleString()}</div>
                </div>
                <div class="summary-card pagi-expenses">
                    <h4>הוצאות קרן התורה</h4>
                    <div class="amount">₪${(data.banks.pagiKeren.scholarships + data.banks.pagiKeren.salaries).toLocaleString()}</div>
                </div>
                <div class="summary-card">
                    <h4>יתרה קרן התורה</h4>
                    <div class="amount" style="color: ${(data.banks.pagiKeren.income - (data.banks.pagiKeren.scholarships + data.banks.pagiKeren.salaries)) >= 0 ? '#28a745' : '#dc3545'};">₪${(data.banks.pagiKeren.income - (data.banks.pagiKeren.scholarships + data.banks.pagiKeren.salaries)).toLocaleString()}</div>
                </div>
            </div>
            
            <h3 style="background: linear-gradient(135deg, #6f42c1, #e83e8c); color: white; padding: 15px 25px; border-radius: 10px; margin-bottom: 20px; text-align: center;">בית המדרש</h3>
            
            <div class="summary-cards">
                <div class="summary-card pagi-income">
                    <h4>הכנסות בית המדרש</h4>
                    <div class="amount">₪${data.banks.pagiBeit.income.toLocaleString()}</div>
                </div>
                <div class="summary-card pagi-expenses">
                    <h4>הוצאות בית המדרש</h4>
                    <div class="amount">₪${data.banks.pagiBeit.expenses.toLocaleString()}</div>
                </div>
                <div class="summary-card">
                    <h4>יתרה בית המדרש</h4>
                    <div class="amount" style="color: ${(data.banks.pagiBeit.income - data.banks.pagiBeit.expenses) >= 0 ? '#28a745' : '#dc3545'};">₪${(data.banks.pagiBeit.income - data.banks.pagiBeit.expenses).toLocaleString()}</div>
                </div>
            </div>
            
            <div class="section-divider">
                <div class="divider-line"></div>
                <div class="divider-text merkantil-divider">בנק מרכנתיל</div>
                <div class="divider-line"></div>
            </div>
            
            <div class="summary-cards">
                <div class="summary-card merkantil-income">
                    <h4>סך הכנסות בנק מרכנתיל</h4>
                    <div class="amount">₪${data.banks.merkantil.income.toLocaleString()}</div>
                </div>
                <div class="summary-card pagi-expenses">
                    <h4>סך הוצאות בנק מרכנתיל</h4>
                    <div class="amount">₪${(data.banks.merkantil.scholarships + data.banks.merkantil.salaries).toLocaleString()}</div>
                </div>
                <div class="summary-card">
                    <h4>יתרה בנק מרכנתיל</h4>
                    <div class="amount" style="color: ${(data.banks.merkantil.income - (data.banks.merkantil.scholarships + data.banks.merkantil.salaries)) >= 0 ? '#28a745' : '#dc3545'};">₪${(data.banks.merkantil.income - (data.banks.merkantil.scholarships + data.banks.merkantil.salaries)).toLocaleString()}</div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>`;
        }

        // הצגת קבצים שנוצרו
        function displayGeneratedFiles() {
            const outputArea = document.getElementById('outputArea');
            const generatedFiles = document.getElementById('generatedFiles');
            
            generatedFiles.innerHTML = '';
            
            generatedFilesData.forEach((file, index) => {
               const fileDiv = document.createElement('div');
               fileDiv.className = 'file-output';
               
               fileDiv.innerHTML = `
                   <div class="file-header">
                       <h4>${file.title}</h4>
                       <button class="download-btn" onclick="downloadFileByIndex(${index})">הורד קובץ</button>
                   </div>
                   <div class="code-preview">${file.content.substring(0, 300).replace(/</g, '&lt;').replace(/>/g, '&gt;')}...</div>
               `;
               
               generatedFiles.appendChild(fileDiv);
           });
           
           outputArea.style.display = 'block';
           alert('הדוחות נוצרו בהצלחה! גלול למטה כדי להוריד אותם.');
       }

       // הורדת קובץ לפי אינדקס
       function downloadFileByIndex(index) {
           const file = generatedFilesData[index];
           if (file) {
               const blob = new Blob([file.content], { type: 'text/html;charset=utf-8' });
               const link = document.createElement('a');
               link.href = URL.createObjectURL(blob);
               link.download = file.name;
               document.body.appendChild(link);
               link.click();
               document.body.removeChild(link);
               URL.revokeObjectURL(link.href);
               
               // הודעה על הורדה מוצלחת
               alert(`הקובץ "${file.name}" הורד בהצלחה!`);
           } else {
               alert('שגיאה בהורדת הקובץ');
           }
       }

       // בדיקה שהדף נטען
       document.addEventListener('DOMContentLoaded', function() {
           console.log('מחולל הדוחות נטען בהצלחה!');
       });

   </script>
</body>
</html>
